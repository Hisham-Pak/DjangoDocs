# .github/workflows/offline-docs.yml
name: Build Offline Django Docs

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *" # daily (keeps dev fresh)

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # required to create/update the release

    steps:
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git make zip jq curl

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build docs zips + manifest.json
        env:
          OUT_DIR: out
        run: |
          set -euo pipefail
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          REPO_URL="https://github.com/django/django.git"

          echo "Discovering tags..." >&2
          TAGS=$(git ls-remote --tags "$REPO_URL" \
            | awk '{print $2}' \
            | sed 's#refs/tags/##' \
            | sed 's#\^{}##' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          # Unique series X.Y, filter >= 1.8
          SERIES=$(echo "$TAGS" \
            | awk -F. '{print $1"."$2}' \
            | sort -Vu \
            | awk -F. '($1>1)||($1==1&&$2>=8){print $0}')

          echo "Series to process (>=1.8):" >&2
          echo "$SERIES" >&2

          META="$OUT_DIR/meta.txt"
          : > "$META"

          # Get commit SHA for a tag (works for annotated/lightweight tags)
          sha_for_tag () {
            local TAG="$1"
            local SHA
            SHA=$(git ls-remote "$REPO_URL" "refs/tags/${TAG}^{}" | awk '{print $1}' || true)
            if [ -z "${SHA:-}" ]; then
              SHA=$(git ls-remote "$REPO_URL" "refs/tags/${TAG}" | awk '{print $1}' || true)
            fi
            echo "${SHA:-}"
          }

          # Download official zip for older docs (1.8 <= X.Y < 4.2)
          download_official_zip () {
            local SLUG="$1"   # "4.1"
            local REF="$2"    # latest patch tag e.g. "4.1.13"
            local URL="https://media.djangoproject.com/docs/django-docs-${SLUG}-en.zip"
            local ZIP_NAME="django-docs-${SLUG}-en.zip"

            echo "=== Downloading $SLUG from $URL (ref $REF) ===" >&2

            # fail fast if missing
            curl -fsI "$URL" >/dev/null

            # download
            curl -fL "$URL" -o "${OUT_DIR}/${ZIP_NAME}"

            local SHA
            SHA="$(sha_for_tag "$REF")"

            # IMPORTANT: This is the ONLY stdout line from this function
            printf "%s %s %s\n" "$SLUG" "$REF" "$SHA"
          }

          build_from_ref () {
            local SLUG="$1"  # "5.2" or "dev"
            local REF="$2"   # tag like "5.2.10" or branch "main"

            echo "=== Building $SLUG from $REF ===" >&2
            rm -rf django

            git clone --quiet --depth 1 --branch "$REF" "$REPO_URL" django

            python -m pip install -q -U pip wheel setuptools
            python -m pip install -q -r django/docs/requirements.txt

            (cd django/docs && make html) >&2

            ZIP_NAME="django-docs-${SLUG}-en.zip"
            (cd django/docs/_build/html && zip -qr "../../../../${OUT_DIR}/${ZIP_NAME}" .) >&2

            local SHA
            SHA=$(cd django && git rev-parse HEAD)

            # IMPORTANT: This is the ONLY stdout line from this function
            printf "%s %s %s\n" "$SLUG" "$REF" "$SHA"
          }

          # Process each series:
          # - For 1.8 <= X.Y < 4.2: download official zip
          # - For X.Y >= 4.2: build from source
          while read -r S; do
            [ -z "$S" ] && continue

            LATEST=$(echo "$TAGS" | grep -E "^${S}\.[0-9]+$" | tail -n 1)
            if [ -z "$LATEST" ]; then
              echo "No tag found for series $S" >&2
              exit 1
            fi

            MAJOR="${S%%.*}"
            MINOR="${S#*.}"

            if [ "$MAJOR" -lt 4 ] || { [ "$MAJOR" -eq 4 ] && [ "$MINOR" -lt 2 ]; }; then
              download_official_zip "$S" "$LATEST" >> "$META"
            else
              build_from_ref "$S" "$LATEST" >> "$META"
            fi
          done <<< "$SERIES"

          # Build dev from latest main
          build_from_ref "dev" "main" >> "$META"

          echo "Clean meta lines:" >&2
          cat "$META" >&2

          # ---------- Generate manifest.json ----------
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          TAG="offline-docs"
          GENERATED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          jq -n \
            --arg generatedAt "$GENERATED_AT" \
            --arg releaseTag "$TAG" \
            '{
              generatedAt: $generatedAt,
              releaseTag: $releaseTag,
              versions: []
            }' > "$OUT_DIR/manifest.json"

          # Filter ONLY valid slugs: dev or X.Y
          # Also de-duplicate by slug (keep first occurrence)
          awk '
            $1=="dev" || $1 ~ /^[0-9]+\.[0-9]+$/ {print $0}
          ' "$META" | awk '!seen[$1]++' > "$OUT_DIR/meta.clean.txt"

          # Sort: dev first, then numeric desc
          awk '
            $1=="dev" {print "9999.9999 " $0; next}
            {split($1,a,"."); printf("%04d.%04d %s\n", a[1], a[2], $0)}
          ' "$OUT_DIR/meta.clean.txt" | sort -r | while read -r KEY SLUG REF SHA; do
            ASSET="django-docs-${SLUG}-en.zip"
            URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${ASSET}"

            jq \
              --arg slug "$SLUG" \
              --arg ref "$REF" \
              --arg sha "$SHA" \
              --arg zipUrl "$URL" \
              --arg pageUrl "https://docs.djangoproject.com/en/${SLUG}/" \
              '.versions += [{slug:$slug, pageUrl:$pageUrl, zipUrl:$zipUrl, sha:$sha, ref:$ref}]' \
              "$OUT_DIR/manifest.json" > "$OUT_DIR/manifest.tmp.json"

            mv "$OUT_DIR/manifest.tmp.json" "$OUT_DIR/manifest.json"
          done

          MANIFEST_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/manifest.json"
          jq --arg manifestUrl "$MANIFEST_URL" '.manifestUrl=$manifestUrl' \
            "$OUT_DIR/manifest.json" > "$OUT_DIR/manifest.tmp.json" && mv "$OUT_DIR/manifest.tmp.json" "$OUT_DIR/manifest.json"

          echo "Manifest final:" >&2
          cat "$OUT_DIR/manifest.json" >&2

      - name: Publish/Update Release assets (offline-docs)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: offline-docs
          name: Offline Docs
          draft: false
          prerelease: false
          files: |
            out/*.zip
            out/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
