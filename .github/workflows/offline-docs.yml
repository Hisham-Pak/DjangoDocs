# .github/workflows/offline-docs.yml
name: Build Offline Django Docs

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *" # daily (keeps dev fresh)

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # required to create/update the release

    steps:
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git make zip jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build docs zips + manifest.json
        env:
          OUT_DIR: out
        run: |
          set -euo pipefail
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          REPO_URL="https://github.com/django/django.git"

          echo "Discovering tags..."
          TAGS=$(git ls-remote --tags "$REPO_URL" \
            | awk '{print $2}' \
            | sed 's#refs/tags/##' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          # Unique series X.Y
          SERIES=$(echo "$TAGS" | awk -F. '{print $1"."$2}' | sort -Vu)

          # Filter >= 4.2
          SERIES=$(echo "$SERIES" | awk -F. '($1>4)||($1==4&&$2>=2){print $0}')

          echo "Series to build (>=4.2):"
          echo "$SERIES"

          build_from_ref () {
            local SLUG="$1"  # "5.2" or "dev"
            local REF="$2"   # tag like "5.2.3" or branch "main"

            echo "=== Building $SLUG from $REF ==="
            rm -rf django
            git clone --depth 1 --branch "$REF" "$REPO_URL" django

            python -m pip install -U pip wheel setuptools
            python -m pip install -r django/docs/requirements.txt

            (cd django/docs && make html)

            ZIP_NAME="django-docs-${SLUG}-en.zip"
            (cd django/docs/_build/html && zip -qr "../../../../${OUT_DIR}/${ZIP_NAME}" .)

            local SHA
            SHA=$(cd django && git rev-parse HEAD)
            echo "$SLUG $REF $SHA"
          }

          META="$OUT_DIR/meta.txt"
          : > "$META"

          # Build stable series (X.Y) using latest patch tag (X.Y.Z)
          while read -r S; do
            LATEST=$(echo "$TAGS" | grep -E "^${S}\.[0-9]+$" | tail -n 1)
            if [ -z "$LATEST" ]; then
              echo "No tag found for series $S"
              exit 1
            fi
            build_from_ref "$S" "$LATEST" >> "$META"
          done <<< "$SERIES"

          # Build dev from latest main
          build_from_ref "dev" "main" >> "$META"

          echo "Build meta:"
          cat "$META"

          # Create manifest.json
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          TAG="offline-docs"

          GENERATED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          jq -n \
            --arg generatedAt "$GENERATED_AT" \
            --arg releaseTag "$TAG" \
            '{
              generatedAt: $generatedAt,
              releaseTag: $releaseTag,
              versions: []
            }' > "$OUT_DIR/manifest.json"

          # Sort: dev first, then numeric desc
          # meta lines: SLUG REF SHA
          awk '
            $1=="dev" {print "9999.9999 " $0; next}
            {split($1,a,"."); printf("%04d.%04d %s\n", a[1], a[2], $0)}
          ' "$META" | sort -r | while read -r KEY SLUG REF SHA; do
            ASSET="django-docs-${SLUG}-en.zip"
            URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/${ASSET}"

            jq \
              --arg slug "$SLUG" \
              --arg ref "$REF" \
              --arg sha "$SHA" \
              --arg zipUrl "$URL" \
              --arg pageUrl "https://docs.djangoproject.com/en/${SLUG}/" \
              '.versions += [{slug:$slug, pageUrl:$pageUrl, zipUrl:$zipUrl, sha:$sha, ref:$ref}]' \
              "$OUT_DIR/manifest.json" > "$OUT_DIR/manifest.tmp.json"

            mv "$OUT_DIR/manifest.tmp.json" "$OUT_DIR/manifest.json"
          done

          MANIFEST_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/manifest.json"
          jq --arg manifestUrl "$MANIFEST_URL" '.manifestUrl=$manifestUrl' \
            "$OUT_DIR/manifest.json" > "$OUT_DIR/manifest.tmp.json" && mv "$OUT_DIR/manifest.tmp.json" "$OUT_DIR/manifest.json"

          echo "Manifest:"
          cat "$OUT_DIR/manifest.json"

      - name: Publish/Update Release assets (offline-docs)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: offline-docs
          name: Offline Docs
          draft: false
          prerelease: false
          files: |
            out/*.zip
            out/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
